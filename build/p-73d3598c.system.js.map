{"version":3,"names":["__extends","X509Certificate","_super","raw","_this","call","this","certificateRawToBuffer","Certificate","thumbprints","type","tbsCertificate","asn","serialNumber","Convert","ToHex","subject","Name","toJSON","issuer","version","notBefore","validity","utcTime","generalTime","Error","notAfter","dateDiff","prototype","parseExtensions","extensions","map","e","Extension","AsnConvert","serialize","getPublicKeyInfo","publicKeyInfo","subjectPublicKey","algorithm","params","id_ecPublicKey","parameters","parse","ECParameters","id_rsaEncryption","RSAPublicKey","id_composite_key","CompositePublicKey","param","spki","value","Object","defineProperty","subjectPublicKeyInfo","_a","signatureValue","signatureAlgorithm","id_alg_composite","compositeSignatureValues_1","CompositeSignatureValue","compositeParams","CompositeParams","index","assign","exportAsBase64","ToBase64","exportAsHexFormatted","hexFormat","exportAsPemFormatted","concat","base64Format","getThumbprint","getCertificateThumbprint","thumbprint","sent","console","error","error_1","i","length","name","shortName","JSON","stringify","subjectToString","join","issuerToString","downloadAsPEM","Download","cert","asPEM","commonName","downloadAsDER","asDER","AsnData"],"sources":["src/crypto/x509_certificate.ts"],"sourcesContent":["/**\n * @license\n * Copyright (c) Peculiar Ventures, LLC.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { AsnConvert } from '@peculiar/asn1-schema';\nimport { ECParameters, id_ecPublicKey } from '@peculiar/asn1-ecc';\nimport { id_rsaEncryption, RSAPublicKey } from '@peculiar/asn1-rsa';\nimport {\n  id_composite_key,\n  id_alg_composite,\n  CompositePublicKey,\n  CompositeSignatureValue,\n  CompositeParams,\n} from '@peculiar/asn1-x509-post-quantum';\nimport { Certificate, SubjectPublicKeyInfo } from '@peculiar/asn1-x509';\nimport { Convert } from 'pvtsutils';\n\nimport { dateDiff, Download } from '../utils';\n\nimport { Name, INameJSON } from './name';\nimport { Extension, TExtensionValue } from './extension';\nimport { AsnData } from './asn_data';\nimport {\n  certificateRawToBuffer,\n  hexFormat,\n  base64Format,\n  getCertificateThumbprint,\n} from './utils';\n\nexport interface ISignature {\n  algorithm: string;\n  value: BufferSource;\n  params?: {\n    algorithm: string;\n    value: BufferSource;\n  }[];\n}\n\nexport interface IPublicKey {\n  algorithm: string;\n  value: BufferSource;\n  params?: ECParameters | RSAPublicKey | IPublicKey[];\n}\n\nexport class X509Certificate extends AsnData<Certificate> {\n  public readonly serialNumber: string;\n\n  public readonly subject: INameJSON[];\n\n  public readonly issuer: INameJSON[];\n\n  public readonly notBefore: Date;\n\n  public readonly notAfter: Date;\n\n  public readonly validity: string;\n\n  public extensions: Extension<TExtensionValue>[];\n\n  public readonly version: number;\n\n  public thumbprints: Record<string, string> = {};\n\n  public type: string = 'X.509 Certificate';\n\n  constructor(raw: string) {\n    super(certificateRawToBuffer(raw), Certificate);\n\n    const { tbsCertificate } = this.asn;\n\n    this.serialNumber = Convert.ToHex(tbsCertificate.serialNumber);\n    this.subject = new Name(tbsCertificate.subject).toJSON();\n    this.issuer = new Name(tbsCertificate.issuer).toJSON();\n    this.version = tbsCertificate.version + 1;\n\n    const notBefore = tbsCertificate.validity.notBefore.utcTime\n      || tbsCertificate.validity.notBefore.generalTime;\n\n    if (!notBefore) {\n      throw new Error(\"Cannot get 'notBefore' value\");\n    }\n\n    this.notBefore = notBefore;\n\n    const notAfter = tbsCertificate.validity.notAfter.utcTime\n      || tbsCertificate.validity.notAfter.generalTime;\n\n    if (!notAfter) {\n      throw new Error(\"Cannot get 'notAfter' value\");\n    }\n\n    this.notAfter = notAfter;\n    this.validity = dateDiff(this.notBefore, this.notAfter);\n  }\n\n  public parseExtensions() {\n    const { tbsCertificate } = this.asn;\n\n    if (tbsCertificate.extensions) {\n      this.extensions = tbsCertificate.extensions\n        .map((e) => new Extension(AsnConvert.serialize(e)));\n    }\n  }\n\n  private getPublicKeyInfo(publicKeyInfo: SubjectPublicKeyInfo) {\n    const { subjectPublicKey, algorithm } = publicKeyInfo;\n    let params;\n\n    if (algorithm.algorithm === id_ecPublicKey && algorithm.parameters) {\n      params = AsnConvert.parse(algorithm.parameters, ECParameters);\n    }\n\n    if (algorithm.algorithm === id_rsaEncryption) {\n      params = AsnConvert.parse(subjectPublicKey, RSAPublicKey);\n    }\n\n    if (algorithm.algorithm === id_composite_key) {\n      params = AsnConvert.parse(subjectPublicKey, CompositePublicKey);\n\n      params = params.map((param) => this.getPublicKeyInfo(param));\n    }\n\n    const spki = AsnConvert.serialize(publicKeyInfo);\n\n    return {\n      params,\n      value: spki,\n      algorithm: algorithm.algorithm,\n    };\n  }\n\n  public get publicKey(): IPublicKey {\n    return this.getPublicKeyInfo(this.asn.tbsCertificate.subjectPublicKeyInfo);\n  }\n\n  public get signature(): ISignature {\n    const { signatureValue, signatureAlgorithm } = this.asn;\n    let params;\n\n    if (signatureAlgorithm.algorithm === id_alg_composite) {\n      const compositeSignatureValues = AsnConvert.parse(signatureValue, CompositeSignatureValue);\n      const compositeParams = AsnConvert.parse(signatureAlgorithm.parameters, CompositeParams);\n\n      params = compositeParams.map((param, index) => ({\n        ...param,\n        value: compositeSignatureValues[index],\n      }));\n    }\n\n    return {\n      params,\n      value: signatureValue,\n      algorithm: signatureAlgorithm.algorithm,\n    };\n  }\n\n  public exportAsBase64() {\n    return Convert.ToBase64(this.raw);\n  }\n\n  public exportAsHexFormatted() {\n    return hexFormat(Convert.ToHex(this.raw));\n  }\n\n  public exportAsPemFormatted() {\n    return `-----BEGIN CERTIFICATE-----\\n${base64Format(this.exportAsBase64())}\\n-----END CERTIFICATE-----`;\n  }\n\n  public async getThumbprint(\n    algorithm: string = 'SHA-1',\n  ): Promise<void> {\n    try {\n      const thumbprint = await getCertificateThumbprint(algorithm, this.raw);\n\n      if (thumbprint) {\n        this.thumbprints[algorithm] = Convert.ToHex(thumbprint);\n      }\n    } catch (error) {\n      console.error('Error thumbprint get:', error);\n    }\n  }\n\n  public get commonName(): string {\n    if (!this.subject) {\n      return '';\n    }\n\n    for (let i = 0; i < this.subject.length; i += 1) {\n      const name = this.subject[i];\n\n      if (name.shortName === 'CN' || name.shortName === 'E' || name.shortName === 'O') {\n        return name.value;\n      }\n    }\n\n    return '';\n  }\n\n  public get issuerCommonName(): string {\n    if (!this.issuer) {\n      return '';\n    }\n\n    for (let i = 0; i < this.issuer.length; i += 1) {\n      const name = this.issuer[i];\n\n      if (name.shortName === 'CN') {\n        return name.value;\n      }\n\n      if (name.shortName === 'E') {\n        return name.value;\n      }\n    }\n\n    return '';\n  }\n\n  public get isRoot(): boolean {\n    return JSON.stringify(this.issuer) === JSON.stringify(this.subject);\n  }\n\n  public subjectToString() {\n    if (!this.subject) {\n      return '';\n    }\n\n    return this.subject\n      .map((name) => (\n        `${name.shortName}=${name.value}`\n      ))\n      .join(', ');\n  }\n\n  public issuerToString() {\n    if (!this.issuer) {\n      return '';\n    }\n\n    return this.issuer\n      .map((name) => (\n        `${name.shortName}=${name.value}`\n      ))\n      .join(', ');\n  }\n\n  public downloadAsPEM(name?: string) {\n    Download.cert.asPEM(\n      this.exportAsPemFormatted(),\n      name || this.commonName,\n    );\n  }\n\n  public downloadAsDER(name?: string) {\n    Download.cert.asDER(\n      this.exportAsHexFormatted(),\n      name || this.commonName,\n    );\n  }\n}\n"],"mappings":"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"}